<!doctype html>
<html>
<head>
	<title>Ludum Dare 25</title>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script type="text/javascript" src="js/common.js"></script>
	<script type="text/javascript" src="js/keyhandler.js"></script>
	<script type="text/javascript" src="js/entity.js"></script>
<script type="text/javascript">

function Particle(args)
{
	if(args == undefined)
		args = {};

	InheretFrom(this, Entity, args);

	this.image = args.image || null;
	this.wobble = 0.0;

	this.Update = function(elapsedTime)
	{

		this.x += Math.sin(0.2*this.wobble)*2;
		this.wobble += 1;
		this.y -= (600 * elapsedTime);

		return true;
	}

	this.Draw = function(rc)
	{
		rc.drawImage(this.image, this.x, this.y, this.w, this.h);
		return true;
	}
}

function Player(args)
{
	if(args == undefined)
		args = {};

	InheretFrom(this, Entity, args);

	this.Update = function(elapsedTime, args)
	{
		if(args == undefined)
			args = {};

		var keyboard = args.keyboard;

		if(keyboard.keyIs("a"))
		{

		}

		if(keyboard.keyIs("d"))
		{

		}

		if(keyboard.keyIs("w"))
		{

		}

		if(keyboard.keyIs("s"))
		{

		}

		return true;
	}

	this.Draw = function(rc)
	{
		return true;
	}
}

CurrentContext = {
	entities: []
};

Game = {};
Game.Images = {};

GameState_MainMenu = 0;
GameState_PauseMenu = 1;
GameState_Playing = 2;

Game.Width = 800;
Game.Height = 600;
Game.Canvas = null;
Game.Context = null;
Game.BackCanvas = null;
Game.BackContext = null;
Game.Keyboard = null;
Game.Mouse = null;
Game.State = 0;
Game.Running = false;

Game.LastTime = 0.0;
Game.CurrentTime = 0.0;
Game.ElapsedTime = 0.0;

Game.GetElapsedTime = function()
{
	Game.LastTime = Game.CurrentTime;
	Game.CurrentTime = +(new Date());
	Game.ElapsedTime = Game.CurrentTime - Game.LastTime;
	return (Game.ElapsedTime/1000);
}

Game.Initialize = function()
{
	Game.Canvas = document.getElementById("game-canvas");
	Game.Context = Game.Canvas.getContext("2d");

	Game.BackCanvas = document.createElement("canvas");
	Game.BackCanvas.width = Game.Canvas.width;
	Game.BackCanvas.height = Game.Canvas.height;
	Game.BackContext = Game.BackCanvas.getContext("2d");

	Game.Keyboard = new KeyHandler();
	Game.State = GameState_MainMenu;

	// init images
	Game.Images["MainMenuBackground"] = new Image();
	Game.Images["MainMenuBackground"].src = "img/MainMenu.png";

	Game.Images["RedParticle"] = new Image();
	Game.Images["RedParticle"].src = "img/RedParticle.png";
}

Game.Buffer = function()
{
	return Game.BackContext;
}

Game.Flip = function()
{
	return Game.Context.drawImage(Game.BackCanvas, 0, 0, Game.Width, Game.Height);
}

// The dispatcher function
Game.Run = function()
{
	var elapsed_time = Game.GetElapsedTime();

	switch(Game.State)
	{
		case GameState_MainMenu:
		{
			Game.MainMenu(elapsed_time);
			break;
		}

		case GameState_PauseMenu:
		{
			Game.PauseMenu();
			break;
		}

		case GameState_Playing:
		{
			Game.Playing();
			break;
		}
	}

	Game.Flip();
	requestAnimFrame(Game.Run);
}

Game.MainMenu = function(elapsedTime)
{
	Game.Buffer().drawImage(Game.Images["MainMenuBackground"], 0, 0, Game.Width, Game.Height);

	// Randomly display particles on the screen
	if(RandomInt(100) < 15)
	{
		var particle = new Particle({x: RandomInt(Game.Width), y: Game.Height, image: Game.Images["RedParticle"], w: 10, h: 10})
		CurrentContext.entities.push(particle);
	}

	// update the screen
	for(var i = 0; i < CurrentContext.entities.length; i++)
	{
		var entity = CurrentContext.entities[i];
		entity.Update(elapsedTime);
	}

	//draw the entities
	for(var i = 0; i < CurrentContext.entities.length; i++)
	{
		var entity = CurrentContext.entities[i];
		entity.Draw(Game.Buffer());
	}
}

Game.PauseMenu = function(elapsedTime)
{

}

Game.Playing = function(elapsedTime)
{

}

window.onload = function()
{
	Game.Initialize();
	Game.Run();
}

</script>
</head>
<body>
	<div class="container">
		<canvas id="game-canvas" width="800px" height="600px"></canvas>
	</div>
</body>
</html>